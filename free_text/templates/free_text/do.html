{% extends "learnpathology/base.html" %}

{% block content %}
    <div class="container">
        <div class="row align-items-center">
            <div class="col">
                <h1>{{ task.question }}</h1>
                <p>{{ task.instructions }}</p>
            </div>
            <div class="col-4" >
                <div class="LPButton" style="margin-top: 0; ">
                    {% if course_id == 0 %}
                        <a href="{% url 'task:list' %}">Task Overview</a>
                    {% else %}
                        <a href=" {% url 'course:view' course_id=course_id return_task=1 %}">Back to course</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="card mx-auto text-center" style="width: 90%; height: 100%; ">
        <div class="card-body" style="height: 100%">
            <div class="row">
                <div class="col">

                </div>
                <div class="col">
                    <form class="form-check text-start"
                          action="{% url 'free_text:do' task_id=task.task_id course_id=course_id %}" method="post">
                        {% csrf_token %}
                        {% if answered == 'yes' %}
                            <textarea name="studentText" cols="40" rows="5">{{ student_text }}</textarea>
                        {% else %}
                            <textarea name="studentText" cols="40" rows="5"></textarea>
                        {% endif %}





                        <input type="submit" value="Submit">
                        {#                        <div class="LPButton" style="margin-top: 0; ">#}
                        {#                            <a href="{% url 'multiple_choice:do' task_id=next_id course_id=course_id %}">Next Task</a>#}
                        {#                        </div>#}
                    </form>

                </div>
                <div class="col">
                    {% if answered == 'yes' %}
                        <div class="card border-success">
                        <div class="card-tile">
                            Optimal answer

                        </div>
                        <div class="card-body">
                              {{ task.answer }}
                        </div>
                        </div>


                    {% endif %}
                </div>
            </div>

            <br>

            {% include 'slide/view_wsi.html' with slide=task.task.annotated_slide.slide annotated_slide=task.task.annotated_slide %}


        </div>
    </div>



    <script>
        viewer.addHandler('viewport-change', updateTextLocation);
        viewer.addHandler('tile-drawing', updateTextLocation);
        addEventListener("resize", () => {
        });

        onresize = () => {
            timer = setTimeout(function () {

                updateTextLocation();

            }, 20);
        };

        function updateTextLocation(event) {

            let slide_overlays = viewer.currentOverlays;


            let arrow_overlays = $("[id^=right-arrow-overlay-]")
            let text_overlays = $("[id^=arrow-text-overlay-]")


            for (let i = 0; i < arrow_overlays.length; i++) {

                let arrowElement = arrow_overlays[i];
                let textElement = text_overlays[i];


                let arrowX = parseFloat(arrowElement.style.left);
                let arrowY = parseFloat(arrowElement.style.top);


                let viewportPoint = viewer.viewport.pointFromPixel(new OpenSeadragon.Point(arrowX - 5, arrowY + 15));
                viewer.updateOverlay(textElement, viewportPoint);
            }


        }

    </script>
{% endblock content %}
