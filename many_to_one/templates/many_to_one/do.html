{% extends "learnpathology/base.html" %}

{% block content %}
    <div class="container">
        <div class="row align-items-center">
            <div class="col">
                <h1>{{ task.question }}</h1>
                <p>{{ task.instructions }}</p>
            </div>
            <div class="col-4">
                <div class="LPButton" style="margin-top: 0; ">
                    {% if course_id == 0 %}
                        <a href="{% url 'task:list' %}">Task Overview</a>
                    {% else %}
                        <a href=" {% url 'course:view' course_id=course_id active_tab='tasks' %}">Back to course</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="card mx-auto text-center" style="width: 90%; height: 100%; ">
        <div class="card-body" style="height: 100%">

  <div class="row">
    <div class="col-md-8">
      <h2>{{ task.question }}</h2>
      <p>{{ task.instructions }}</p>
      <div class="row">
        {% for column in task.tablecolumn_set.all %}
        <div class="col-md-4">
          <h3>{{ column.caption }}</h3>
          <ul class="sortable-list" id="sortable-list-{{ column.id }}"></ul>
        </div>
        {% endfor %}
      </div>
    </div>
    <div class="col-md-4">
      <h3>All Answers</h3>
      <ul class="sortable-list" id="sortable-list-all">
        {% for row in task.tablerow_set.all %}
        <li>{{ row.answer }}</li>
        {% endfor %}
      </ul>

  </div>
</div>


            <br>

            {% include 'slide/view_wsi.html' with slide=task.task.annotated_slide.slide annotated_slide=task.task.annotated_slide %}


        </div>
    </div>



    <script>
        $(function() {
  $(".sortable-list").sortable({
    connectWith: ".sortable-list",
    placeholder: "ui-state-highlight",
    dropOnEmpty: true,
    receive: function(event, ui) {
      // Update the answer_order list with the new order of answers
      var answer_order = [];
      $("#sortable-list-all li").each(function() {
        answer_order.push($(this).text());
      });
      // Send the updated answer_order to the server

    }
  });
});

        viewer.addHandler('viewport-change', updateTextLocation);
        viewer.addHandler('tile-drawing', updateTextLocation);

        addEventListener("resize", () => {
        });

        onresize = () => {
            timer = setTimeout(function () {

                updateTextLocation();

            }, 20);
        };


        function updateTextLocation(event) {

            let arrow_overlays = $("[id^=right-arrow-overlay-]")
            let text_overlays = $("[id^=arrow-text-overlay-]")

            for (let i = 0; i < arrow_overlays.length; i++) {

                let arrowElement = arrow_overlays[i];
                let textElement = text_overlays[i];

                let arrowX = parseFloat(arrowElement.style.left);
                let arrowY = parseFloat(arrowElement.style.top);

                let viewportPoint = viewer.viewport.pointFromPixel(new OpenSeadragon.Point(arrowX - 5, arrowY + 15));
                viewer.updateOverlay(textElement, viewportPoint);
            }
        }




    </script>
{% endblock content %}
