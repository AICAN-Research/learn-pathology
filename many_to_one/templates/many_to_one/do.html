{% extends "learnpathology/base.html" %}

{% block content %}
    <div class="container">
        <div class="row align-items-center">
            <div class="col">
                <h1>{{ task.question }}</h1>
                <p>{{ task.instructions }}</p>
            </div>
            <div class="col-4">
                <div class="LPButton" style="margin-top: 0; ">
                    {% if course_id == 0 %}
                        <a href="{% url 'task:list' %}">Task Overview</a>
                    {% else %}
                        <a href=" {% url 'course:view' course_id=course_id active_tab='tasks' %}">Back to course</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="card mx-auto text-center" style="width: 90%; height: 100%; ">
        <div class="card-body" style="height: 100%">

            <div class="row">
                <div class="col-md-10">
                    <div class="row">
                        {% for column in task.tablecolumn_set.all %}
                            <div class="col-md-2">
                                <div class="list group">
                                    <div class="list-group-item fixed">{{ column.caption }}</div>

                                    <ul class="list-group " id="sortable-list-{{ column.id }}">


                                        <li class="list-group-item ">   </li>
                                    </ul>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-2">
                    <ul class="list-group " id="sortable-list-all">
                        <li class="list-group-item ui-state-default ui-state-disabled disabled"> Answers</li>
                        {% for column_form in task.tablecolumn_set.all %}

                            {% for row_form in column_form.tablerow_set.all %}

                                <li class="list-group-item">{{ row_form.answer }}</li>

                            {% endfor %}
                        {% endfor %}
                    </ul>

                </div>
            </div>


            <br>

            {% include 'slide/view_wsi.html' with slide=task.task.annotated_slide.slide annotated_slide=task.task.annotated_slide %}


        </div>
    </div>

<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/smoothness/jquery-ui.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
    <script>
        $('ul.list-group').each(function () {
            // Get the id of the current list
            var id = $(this).attr('id');
            console.log(id)

            // Make the current list sortable and connect it to all other lists with class 'list-group'
            $('#' + id).sortable({
                connectWith: ".list-group",
                dropOnEmpty: false
            }).disableSelection();
        });

        $(function () {
            $("#sortable").sortable({
                connectWith: ".list-group",
                appendTo: ".list-group",
                items: "> li:not(.fixed)" // only allow sorting of items that are not fixed
            }).disableSelection();
        });


        {#var sortableLists = document.querySelectorAll('.sortable');#}
        {#for (var i = 0; i < sortableLists.length; i++) {#}
        {#  var sortableList = sortableLists[i];#}
        {#  var group = sortableList.getAttribute('data-group');#}
        {#  var sortable = new Sortable(sortableList, { group: group, connectWith:'.connectedSortable' });#}
        {#}#}


            viewer.addHandler('viewport-change', updateTextLocation);
            viewer.addHandler('tile-drawing', updateTextLocation);

            addEventListener("resize", () => {
            });

            onresize = () => {
                timer = setTimeout(function () {

                    updateTextLocation();

                }, 20);
            };


            function updateTextLocation(event) {

                let arrow_overlays = $("[id^=right-arrow-overlay-]")
                let text_overlays = $("[id^=arrow-text-overlay-]")

                for (let i = 0; i < arrow_overlays.length; i++) {

                    let arrowElement = arrow_overlays[i];
                    let textElement = text_overlays[i];

                    let arrowX = parseFloat(arrowElement.style.left);
                    let arrowY = parseFloat(arrowElement.style.top);

                    let viewportPoint = viewer.viewport.pointFromPixel(new OpenSeadragon.Point(arrowX - 5, arrowY + 15));
                    viewer.updateOverlay(textElement, viewportPoint);
                }
            }


    </script>
{% endblock content %}
