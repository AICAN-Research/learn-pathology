{% extends 'learnpathology/single_content_layout.html' %}
{% load slide_filters %}
{% load static %}


{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'slide:browser' %}">Image browser</a></li>
<li class="breadcrumb-item active" aria-current="page">Viewer: {{ slide.name }}</li>
{% endblock breadcrumb_items %}


{% block page_title %}
{{ slide.name }}
{% endblock page_title %}


{% block button_row %}
{% endblock button_row %}


{% block content %}

<!-- WSI VIEWER -->
<div class="card slideViewerCard transparentBackground">
    <div id="wsi-canvas" class="wsi_canvas" style="height: 100%;"></div>
    {% if annotated_slide %}
        {{ annotated_slide.get_html | safe }}
    {% endif %}
</div>

<script src="{% static 'slide/openseadragon.min.js' %}"></script>
<script src="{% static 'slide/openseadragon-scalebar.js' %}"></script>
<script type="text/javascript">
    let buttonElement = document.createElement("button");
    buttonElement.innerText = "Screenshot";
    let screenshotButton = new OpenSeadragon.Button({
        tooltip: 'Screenshot',
        element: buttonElement,
        //srcRest: `/images/Browser_Chrome.png`,
        //srcGroup: `/images/Browser_Chrome.png`,
        //srcHover: `/images/Browser_Chrome.png`,
        //srcDown: `/images/Browser_Chrome.png`,
        onClick: function () {
            console.log('Click!');
            // Hide toolbar:
            let toolbar = document.getElementsByClassName("openseadragon-container")[0].childNodes[1];
            toolbar.style.display = "none";
            html2canvas($("#wsi-canvas")[0]).then(canvas => {
                var now = new Date();
                var formattedDate = now.format("yyyy-MM-dd hh-mm-ss");
                console.log(now);
                // Trigger download
                var link = document.createElement('a');
                link.href = canvas.toDataURL("image/jpeg");
                link.download = 'LearnPathology Screenshot ' + formattedDate + '.jpg';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }).then(x => {
                // Display toolbar again
                let toolbar = document.getElementsByClassName("openseadragon-container")[0].childNodes[1];
                toolbar.style.display = "block";
            })
        }
    });
    let overlayElement = document.createElement("button");
    overlayElement.innerText = "Toggle Annotations";
    let overlayButton = new OpenSeadragon.Button({
        tooltip: 'Toggle Annotations',
        element: overlayElement,
        //srcRest: `/images/Browser_Chrome.png`,
        //srcGroup: `/images/Browser_Chrome.png`,
        //srcHover: `/images/Browser_Chrome.png`,
        //srcDown: `/images/Browser_Chrome.png`,
        onClick: function () {
            console.log('Click!');
            $(".overlay").toggle();
        }
    });
    var viewer = OpenSeadragon({
        id: "wsi-canvas",
        zoomPerScroll: 2, // Scroll speed
        minScrollDeltaTime: 150, //	Number of milliseconds between canvas-scroll events.
        showNavigator: true, // The navigation window top-right
        prefixUrl: "{% static 'slide/images/' %}", // Where to find OpenSedragon button images
        tileSources: {
            width: {{ slide.width }},
            height:  {{ slide.height }},
            tileWidth: {{ slide.tile_width }},
            tileHeight: {{ slide.tile_height }},
            minLevel: 0,
            maxLevel: {{ slide.osd_levels }}-1,
            getTileUrl: function (level, x, y) {
                return "/viewer/tile/{{ slide.id }}/" + ({{ slide.osd_levels }} -1 - level) + "/" + x + "/" + y + "/";
            },
            overlays: [
                {{ annotated_slide.get_js | safe }}
            ],
        }
    });

    try {
        let pixelsPerMeter = {{ slide|get_pixels_per_meter }};
        viewer.scalebar({
            type: OpenSeadragon.ScalebarType.MICROSCOPY,
            pixelsPerMeter: pixelsPerMeter,
            minWidth: "250px",
            location: OpenSeadragon.ScalebarLocation.BOTTOM_LEFT,
            xOffset: 10,
            yOffset: 20,
            stayInsideImage: true,
            color: "rgba(100,100,100,0.9)",
            fontColor: "rgb(50,50,50)",
            backgroundColor: "rgba(230, 230, 230, 0.5)",
            fontSize: "large",
            barThickness: 3
        });
    } catch (e) {
        alert('Couldn\'t get scaling factor')
    }


    viewer.addControl(screenshotButton.element, {anchor: OpenSeadragon.ControlAnchor.TOP_LEFT});

</script>
<script>
    window.onLoad = toggleAnnotationOff();
    window.onLoad = toggleInfoCardVisibility();
    window.onLoad = createClickReaction();

    function createClickReaction() {
        let current_overlays = viewer.currentOverlays;
        for (let i = 0; i < current_overlays.length; i++) {

            new OpenSeadragon.MouseTracker({
                element: current_overlays[i].element,
                clickHandler: function (event) {
                    var list_id = current_overlays[i].element.id.split('-').at(-1);

                    if (current_overlays[i].element.id.includes('boundingbox')) {
                        var list_box = document.getElementById('boundingbox-listitem-' + list_id);
                        console.log(list_box)
                        list_box.style.color = "red";
                        list_box.style.fontWeight = "900"

                        timer = setTimeout(function () {
                            list_box.style.color = "";
                            list_box.style.fontWeight = ""
                        }, 1000);
                    }

                    if (current_overlays[i].element.id.includes('arrow')) {
                        var list_arrow = document.getElementById('arrow-listitem-' + list_id);
                        console.log(list_arrow)

                        list_arrow.style.color = "red";
                        list_arrow.style.fontWeight = "900";

                        timer = setTimeout(function () {
                            list_arrow.style.color = "";
                            list_arrow.style.fontWeight = "";
                        }, 1000);
                    }
                }
            });

        }
    }


    function toggleAnnotationOff() {
        $(".overlay").toggle();
        $(".textOverlay").toggle();
    }

    function highlightAnnotation(annotationId) {
        var list_item = document.getElementById(annotationId);
        var list_id = annotationId.split('-').at(-1);
        if (list_item.id.includes('boundingbox')) {
            var box = document.getElementById('boundingbox-' + list_id);
            var text = document.getElementById('boundingbox-text-overlay-' + list_id);
            console.log(text)
            box.style.borderColor = "red";
            box.style.borderWidth = "5px";

            text.style.color = "red";
            text.style.fontWeight = "900";

            timer = setTimeout(function () {
                box.style.borderColor = "";
                box.style.borderWidth = ""
                text.style.color = "";
                text.style.fontWeight = "";
            }, 1000);
        }

        if (list_item.id.includes('arrow')) {
            var arrow = document.getElementById('right-arrow-overlay-' + list_id);
            var arrow_text = document.getElementById('arrow-text-overlay-' + list_id);
            arrow.style.color = "red";
            arrow.style.fontWeight = "900";

            arrow_text.style.color = "red";
            arrow_text.style.fontWeight = "900";

            timer = setTimeout(function () {
                arrow.style.color = "";
                arrow.style.fontWeight = "";
                arrow_text.style.color = "";
                arrow_text.style.fontWeight = "";
            }, 1000);
        }
    }

    viewer.addHandler('viewport-change', updateTextLocation);
    viewer.addHandler('tile-drawing', updateTextLocation);
    addEventListener("resize", () => {});

    onresize = () => {
        timer = setTimeout(function () {
            updateTextLocation();
        }, 20);
    };

    function updateTextLocation(event) {
        let slide_overlays = viewer.currentOverlays;

        let arrow_overlays = $("[id^=right-arrow-overlay-]")
        let text_overlays = $("[id^=arrow-text-overlay-]")

        for (let i = 0; i < arrow_overlays.length; i++) {
            let arrowElement = arrow_overlays[i];
            let textElement = text_overlays[i];

            let arrowX = parseFloat(arrowElement.style.left);
            let arrowY = parseFloat(arrowElement.style.top);

            let viewportPoint = viewer.viewport.pointFromPixel(new OpenSeadragon.Point(arrowX - 5, arrowY + 15));
            viewer.updateOverlay(textElement, viewportPoint);
        }
    }

    function toggleInfoCardVisibility() {
        var x = document.getElementById("slideInfoCardContent");
        var canvas_viewer = document.getElementById('imageViewer')
        console.log("clicked button to toggle card visibility");
        console.log(x);
        if (x.style.display === "none") {
            x.style.display = "block";
            canvas_viewer.style.width = '';
        } else {
            x.style.display = "none";
            canvas_viewer.style.width = '100%';
        }
        timer = setTimeout(function () {
            updateTextLocation();
        }, 20);
    }

    $(function () {
        $('#toggle-annotation').bootstrapToggle({
            on: ' Annotation',
            off: ' Annotation'
        })
        $('#toggle-annotation').bootstrapToggle('off');
    })
    $(function () {
        $('#toggle-text').bootstrapToggle({
            on: ' Text',
            off: ' Text'
        })
        $('#toggle-text').bootstrapToggle('off');
    })

    $(function () {
        $('#toggle-annotation').change(function () {
            $(".overlay").toggle();
            if ($(this).is(':checked')) {

            } else {
                if ($('#toggle-text').is(':checked')) {
                    $('#toggle-text').bootstrapToggle('off');
                }
            }
        })
    })

    $(function () {
        $('#toggle-text').on('change', function () {
            $(".textOverlay").toggle();
            if ($(this).is(':checked')) {
                if ($('#toggle-annotation').is(':checked')) {

                } else {
                    $('#toggle-annotation').bootstrapToggle('on');
                }
            }
        })
    })


</script>

{% endblock content %}