{% load static %}
{% load slide_filters %}

<div class="container fill" style="min-height: 600px">

<div class="card border-0">

    <div class="row no-gutters w-100">
        <div class="col-sm-5 col-md-3">
            <div class="card border-0 h-100" style="margin-top: auto; margin-bottom: auto">
            <div class="card-body">
                <h5 class="card-title">Annotation type</h5>
            </div>
            </div>
        </div> <!-- end col 1 -->
        <div class="col">
            <div class="card border-0 text-left">
            <div class="card-body">
            <div class="radio-toolbar">
                {% for annotation in annotation_types %}
                    <!-- TODO: Pass annotation type options to template and fill in buttons appropriately -->
                    <!-- <input type="radio" name="annotation-type" id="annotation-type-btn" value="{{ annotation }}" onchange="this.form.submit();"> -->
                    <input type="radio" name="annotation-type" id="annotation-type-btn" value="{{ annotation }}" onchange="">
                    <label for="annotation-type-btn" class="{% if selected_type == annotation %}active{% endif %}">{{ annotation|model_name }}</label>
                {% endfor %}
            </div>
            </div>
            </div>
        </div> <!-- end col 2 -->
    </div> <!-- end row -->

</div>
<div>
    <!-- TODO: Annotation-specific instructions? -->
    <p>Double click where you want to add annotations</p>
</div>


<div id="wsi-canvas" class="wsi_canvas" style="height: 600px;"></div>

</div>

<script src="{% static 'slide/openseadragon.min.js' %}"></script>
<script type="text/javascript">
    var viewer = OpenSeadragon({
    id: "wsi-canvas",
    zoomPerScroll: 2, // Scroll speed
    zoomPerClick: 1, // disable click to zoom
    showNavigator: true, // The navigation window top-right
    prefixUrl: "{% static 'slide/images/' %}", // Where to find OpenSedragon button images
    tileSources:   {
        width: {{ slide.width }},
        height:  {{ slide.height }},
        tileWidth: {{ slide.tile_width }},
        tileHeight: {{ slide.tile_height }},
        minLevel: 0,
        maxLevel: {{ slide.osd_levels }}-1,
        getTileUrl: function( level, x, y ) {
            return "/viewer/tile/{{ slide.id }}/" + ({{ slide.osd_levels }} - 1 - level) + "/" + x + "/" + y + "/";
        },
        overlays: [
            ],
    }
    });
    viewer.innerTracker.keyHandler = null;


    var counter = 1;
    function addPointer(viewportPoint, text) {
       // Create overlay
       let textDiv = document.createElement("div");
       textDiv.className = "overlay";
       let strCounter = counter.toString();
       textDiv.id = "pointer-" + strCounter;
       textDiv.innerHTML = '<a>X</a> ' +
           '<input type="hidden" name="pointer-' + strCounter + '-x" value="' + viewportPoint.x.toString() + '"> ' +
           '<input type="hidden" name="pointer-' + strCounter + '-y" value="' + viewportPoint.y.toString() + '"> ' +
           '<input type="text" name="pointer-' + strCounter + '-text" value="' + text + '"> &#8594;';
       counter += 1;

       viewer.addOverlay(textDiv, viewportPoint, OpenSeadragon.Placement.RIGHT);

        // MouseTracker is required for links to function in overlays
        var asd = new OpenSeadragon.MouseTracker({
            element: textDiv.id,
            clickHandler: function(event) {
                var target = event.originalEvent.target;
                if(target.matches('input')) {
                    target.focus();
                } else if(target.matches('a')) {
                    // Event handler for deleting:
                    viewer.removeOverlay(textDiv.id);
                }
            }
        });
        return textDiv;
    }

    {% for pointer in pointers %}
       addPointer(new OpenSeadragon.Point({{pointer.position_x}}, {{ pointer.position_y }}), '{{ pointer.text }}');
    {% endfor %}

    // TODO: Define below functionality based on which annotation type is selected
    viewer.addHandler('canvas-double-click', function(event) {
        // The canvas-click event gives us a position in web coordinates.
        var webPoint = event.position;

        // Convert that to viewport coordinates, the lingua franca of OpenSeadragon coordinates.
        var viewportPoint = viewer.viewport.pointFromPixel(webPoint);
        var textDiv = addPointer(viewportPoint, '');
        $("#" + textDiv.id + " input[type=text]").focus();
    });

</script>