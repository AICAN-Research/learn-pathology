{% load static %}
{% load slide_filters %}
<div class="container" style="height:85%; background-color: #dcdcdc">
    <div id="wsi-canvas" class="wsi_canvas" style="height: 600px;"></div>
</div>
<script src="{% static 'slide/openseadragon.min.js' %}"></script>
<script src="{% static 'slide/openseadragon-scalebar.js' %}"></script>
<script type="text/javascript">
    var viewer = OpenSeadragon({
        id: "wsi-canvas",
        zoomPerScroll: 2, // Scroll speed
        minScrollDeltaTime: 150, //	Number of milliseconds between canvas-scroll events.
        showNavigator: true, // The navigation window top-right
        prefixUrl: "{% static 'slide/images/' %}", // Where to find OpenSedragon button images
        tileSources: {
            width: {{ slide.width }},
            height:  {{ slide.height }},
            tileWidth: {{ slide.tile_width }},
            tileHeight: {{ slide.tile_height }},
            minLevel: 0,
            maxLevel: {{ slide.osd_levels }}-1,
            getTileUrl: function (level, x, y) {
                return "/viewer/tile/{{ slide.id }}/" + ({{ slide.osd_levels }} -1 - level) + "/" + x + "/" + y + "/";
            },
        },
        clickToZoom: false, // TODO: Fix remove zoom by click OR add own event handler for click/double click
    });

    try {
        let pixelsPerMeter = {{ slide|get_pixels_per_meter }};
        viewer.scalebar({
            type: OpenSeadragon.ScalebarType.MICROSCOPY,
            pixelsPerMeter: pixelsPerMeter,
            minWidth: "250px",
            location: OpenSeadragon.ScalebarLocation.BOTTOM_LEFT,
            xOffset: 10,
            yOffset: 20,
            stayInsideImage: true,
            color: "rgba(100,100,100,0.9)",
            fontColor: "rgb(50,50,50)",
            backgroundColor: "rgba(230, 230, 230, 0.5)",
            fontSize: "large",
            barThickness: 3
        });
    } catch (e) {
        alert("Couldn't get scaling factor")
    }

    let buttonElement = document.createElement("button");
    buttonElement.innerText = "Screenshot";
    let screenshotButton = new OpenSeadragon.Button({
        tooltip: 'Screenshot',
        element: buttonElement,
        //srcRest: `/images/Browser_Chrome.png`,
        //srcGroup: `/images/Browser_Chrome.png`,
        //srcHover: `/images/Browser_Chrome.png`,
        //srcDown: `/images/Browser_Chrome.png`,
        onClick: function () {
            console.log('Click!');
            // Hide toolbar:
            let toolbar = document.getElementsByClassName("openseadragon-container")[0].childNodes[1];
            toolbar.style.display = "none";
            html2canvas($("#wsi-canvas")[0]).then(canvas => {
                var now = new Date();
                var formattedDate = now.format("yyyy-MM-dd hh-mm-ss");
                console.log(now);
                // Trigger download
                var link = document.createElement('a');
                link.href = canvas.toDataURL("image/jpeg");
                link.download = 'LearnPathology Screenshot ' + formattedDate + '.jpg';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }).then(x => {
                // Display toolbar again
                let toolbar = document.getElementsByClassName("openseadragon-container")[0].childNodes[1];
                toolbar.style.display = "block";
            })
        }
    });
    viewer.addControl(screenshotButton.element, {anchor: OpenSeadragon.ControlAnchor.TOP_LEFT});

    viewer.addHandler('open', toggleAnnotationOff); // in normal view
        window.onLoad = toggleAnnotationOff(); // when having the console open

        document.body.addEventListener('dblclick', function (event) {

            let container_correct = document.getElementById('answered_correct');
            let container_false = document.getElementById('answered_false');

            let correct_selection = false;

            let current_overlays = viewer.currentOverlays;
            for (let i = 0; i < current_overlays.length; i++) {

                if (current_overlays[i].element.contains(event.target)) {
                    console.log('Clicked inside');
                    correct_selection = true;
                } else {
                    console.log('Clicked outside');
                }
            }
            if (correct_selection) {
                container_correct.style.display = 'block';
                container_false.style.display = 'none';
            } else {
                container_false.style.display = 'block';
                container_correct.style.display = 'none';
            }
        });

        function toggleAnnotationOff() {
            $(".textOverlay").toggle();

            let current_overlays = viewer.currentOverlays
            for (let i = 0; i < current_overlays.length; i++) {
                let current_element = current_overlays[i].element
                current_element.style.opacity = '0.0';
            }
        }

        function toggleAnnotationOn() {
            let current_overlays = viewer.currentOverlays;
            for (let i = 0; i < current_overlays.length; i++) {
                var current_element = current_overlays[i].element
                current_element.style.opacity = '';
            }
        }

</script>